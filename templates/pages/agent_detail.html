{% extends "layouts/base.html" %}

{% block title %} Agent {{ agent['id'] }} {% endblock %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary shadow-primary border-radius-lg">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-auto">
              <div class="icon icon-shape icon-xl bg-white shadow text-center rounded-circle">
                <i class="fas fa-desktop text-primary text-gradient opacity-10"></i>
              </div>
            </div>
            <div class="col">
              <h3 class="text-white mb-0">Agent {{ agent['id'] }}</h3>
              <p class="text-white opacity-8 mb-0">Remote System Management</p>
            </div>
            <div class="col-auto">
              <span class="badge bg-white text-primary">Active</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Agent Information Cards -->
  <div class="row mb-4">
    <div class="col-lg-6 col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header p-3 pb-0 bg-gradient-info">
          <h6 class="mb-0 text-white">
            <i class="fas fa-info-circle me-2"></i>
            System Information
          </h6>
        </div>
        <div class="card-body p-3">
          <div class="row">
            <div class="col-6">
              <div class="d-flex flex-column mb-3">
                <h6 class="text-uppercase text-body text-xs font-weight-bolder opacity-7">Hostname</h6>
                <span class="text-sm font-weight-bold">{{ agent['hostname'] }}</span>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex flex-column mb-3">
                <h6 class="text-uppercase text-body text-xs font-weight-bolder opacity-7">IP Address</h6>
                <span class="text-sm font-weight-bold">{{ agent['ip'] }}</span>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex flex-column mb-3">
                <h6 class="text-uppercase text-body text-xs font-weight-bolder opacity-7">Operating System</h6>
                <span class="text-sm font-weight-bold">{{ agent['os'] }}</span>
              </div>
            </div>
            <div class="col-6">
              <div class="d-flex flex-column mb-3">
                <h6 class="text-uppercase text-body text-xs font-weight-bolder opacity-7">MAC Address</h6>
                <span class="text-sm font-weight-bold">{{ agent['mac'] }}</span>
              </div>
            </div>
            <div class="col-12">
              <div class="d-flex flex-column">
                <h6 class="text-uppercase text-body text-xs font-weight-bolder opacity-7">Last Seen</h6>
                <span class="text-sm font-weight-bold">{{ agent['last_seen'] }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-lg-6 col-md-6 mb-4">
      <div class="card shadow-sm">
        <div class="card-header p-3 pb-0 bg-gradient-success">
          <h6 class="mb-0 text-white">
            <i class="fas fa-chart-line me-2"></i>
            Quick Actions
          </h6>
        </div>
        <div class="card-body p-3">
          <div class="row g-2">
            <div class="col-6">
              <button class="btn btn-outline-info btn-sm w-100 shadow-sm" onclick="document.getElementById('screenshot-form').submit()">
                <i class="fas fa-camera me-1"></i> Screenshot
              </button>
            </div>
            <div class="col-6">
              <button class="btn btn-outline-success btn-sm w-100 shadow-sm" onclick="document.getElementById('processes-form').submit()">
                <i class="fas fa-tasks me-1"></i> Processes
              </button>
            </div>
            <div class="col-6">
              <button class="btn btn-outline-warning btn-sm w-100 shadow-sm" data-bs-toggle="modal" data-bs-target="#yaraModal">
                <i class="fas fa-search me-1"></i> YARA Scan
              </button>
            </div>
            <div class="col-6">
              <button class="btn btn-outline-secondary btn-sm w-100 shadow-sm" data-bs-toggle="modal" data-bs-target="#directoryModal">
                <i class="fas fa-folder me-1"></i> Browse Files
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Action Forms Section -->
  <div class="row mb-4">
    <!-- File Download -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header p-3 pb-0 bg-gradient-primary">
          <h6 class="mb-0 text-white">
            <i class="fas fa-download me-2"></i>
            Download File
          </h6>
        </div>
        <div class="card-body p-3">
          <form method="POST" action="/admin/download">
            <input type="hidden" name="agent_id" value="{{ agent['id'] }}">
            <input type="hidden" name="agent_url" value="{{ agent['url'] }}">
            <div class="input-group input-group-outline mb-3">
              <input type="text" class="form-control" name="file_path" placeholder="C:/Users/Agent/Documents/file.txt" required>
            </div>
            <button class="btn btn-primary btn-sm w-100" type="submit">
              <i class="fas fa-download me-1"></i> Download File
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Process Management -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header p-3 pb-0 bg-gradient-danger">
          <h6 class="mb-0 text-white">
            <i class="fas fa-skull me-2"></i>
            Process Management
          </h6>
        </div>
        <div class="card-body p-3">
          <form method="POST" action="/admin/kill">
            <input type="hidden" name="agent_id" value="{{ agent['id'] }}">
            <input type="hidden" name="agent_url" value="{{ agent['url'] }}">
            <div class="input-group input-group-outline mb-3">
              <input type="text" class="form-control" name="pid" placeholder="Enter PID to kill" required>
            </div>
            <button class="btn btn-danger btn-sm w-100" type="submit">
              <i class="fas fa-times me-1"></i> Kill Process
            </button>
          </form>
        </div>
      </div>
    </div>

    <!-- Command Execution -->
    <div class="col-lg-4 col-md-6 mb-4">
      <div class="card shadow-sm h-100">
        <div class="card-header p-3 pb-0 bg-gradient-warning">
          <h6 class="mb-0 text-white">
            <i class="fas fa-terminal me-2"></i>
            Execute Command
          </h6>
        </div>
        <div class="card-body p-3">
          <form method="POST" action="/admin/exec">
            <input type="hidden" name="agent_id" value="{{ agent['id'] }}">
            <input type="hidden" name="agent_url" value="{{ agent['url'] }}">
            <div class="input-group input-group-outline mb-3">
              <input type="text" class="form-control" name="command" placeholder="Enter command (e.g., whoami)" required>
            </div>
            <button class="btn btn-warning btn-sm w-100" type="submit">
              <i class="fas fa-play me-1"></i> Run Command
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Hidden Forms for Quick Actions -->
  <div class="d-none">
    <form id="screenshot-form" method="POST" action="/admin/screenshot">
      <input type="hidden" name="agent_id" value="{{ agent['id'] }}">
    </form>

    <form id="processes-form" method="POST" action="/admin/processes">
      <input type="hidden" name="agent_id" value="{{ agent['id'] }}">
      <input type="hidden" name="agent_url" value="{{ agent['url'] }}">
    </form>
  </div>

  <!-- Command Output Display -->
  {% if exec_output %}
  <div class="row mb-4">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header p-3 pb-0 bg-gradient-info">
          <h6 class="mb-0 text-white">
            <i class="fas fa-terminal me-2"></i>
            Command Output
          </h6>
        </div>
        <div class="card-body p-3">
          <div class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow-y: auto;">
            <pre class="mb-0" style="white-space: pre-wrap; font-family: 'Courier New', monospace; font-size: 0.875rem;">{{ exec_output }}</pre>
          </div>
        </div>
      </div>
    </div>
  </div>
  {% endif %}

  <!-- Network Connections Section -->
  <div class="row">
    <div class="col-12">
      <div class="card shadow-sm">
        <div class="card-header p-3 pb-0 bg-gradient-secondary">
          <div class="row align-items-center">
            <div class="col">
              <h5 class="card-title m-0 text-white">
                <i class="fas fa-network-wired me-2"></i>
                Network Connections
              </h5>
              <small class="text-white opacity-8">Real-time monitoring with AbuseIPDB threat intelligence</small>
            </div>
            <div class="col-auto">
              <span class="badge bg-light text-secondary">
                <i class="fas fa-shield-alt me-1"></i>
                Threat Intelligence
              </span>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          {% if conns and conns|length > 0 %}
          <div class="table-responsive">
            <table class="table table-sm table-hover mb-0">
              <thead class="bg-light">
                <tr>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Time</th>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">IP Address</th>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Port</th>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">PID</th>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Process</th>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Threat Score</th>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Reports</th>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Country</th>
                  <th class="border-0 text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Categories</th>
                </tr>
              </thead>
              <tbody>
                {% for c in conns %}
                <tr class="{% if c.abuse_score >= 50 %}table-danger{% elif c.abuse_score >= 10 %}table-warning{% else %}table-light{% endif %}">
                  <td class="align-middle">
                    <span class="text-secondary text-xs font-weight-bold">{{ c.ts or c.received_ts }}</span>
                  </td>
                  <td class="align-middle">
                    <span class="text-dark font-weight-bold">{{ c.ip }}</span>
                  </td>
                  <td class="align-middle">
                    <span class="badge badge-sm bg-gradient-secondary">{{ c.port }}</span>
                  </td>
                  <td class="align-middle">
                    <span class="text-secondary text-xs font-weight-bold">{{ c.pid }}</span>
                  </td>
                  <td class="align-middle">
                    <span class="text-dark text-xs font-weight-bold">{{ c.proc }}</span>
                  </td>
                  <td class="align-middle">
                    {% if c.abuse_score >= 50 %}
                      <span class="badge badge-sm bg-gradient-danger">{{ c.abuse_score }}%</span>
                    {% elif c.abuse_score >= 10 %}
                      <span class="badge badge-sm bg-gradient-warning">{{ c.abuse_score }}%</span>
                    {% else %}
                      <span class="badge badge-sm bg-gradient-success">{{ c.abuse_score }}%</span>
                    {% endif %}
                  </td>
                  <td class="align-middle">
                    <span class="text-secondary text-xs font-weight-bold">{{ c.abuse_reports }}</span>
                  </td>
                  <td class="align-middle">
                    {% if c.country %}
                      <span class="badge badge-sm bg-gradient-info">{{ c.country }}</span>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                  <td class="align-middle">
                    {% if c.categories %}
                      <div class="d-flex flex-wrap gap-1">
                        {% for category in c.categories %}
                          <span class="badge badge-sm bg-gradient-secondary">{{ category }}</span>
                        {% endfor %}
                      </div>
                    {% else %}
                      <span class="text-muted">-</span>
                    {% endif %}
                  </td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% else %}
          <div class="text-center py-5">
            <i class="fas fa-network-wired text-muted" style="font-size: 3rem;"></i>
            <p class="text-muted mt-3 mb-0">No network connection data available</p>
            <small class="text-muted">Network monitoring will appear here when connections are detected</small>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div>
</div>

<!-- YARA Modal -->
<div class="modal fade" id="yaraModal" tabindex="-1" aria-labelledby="yaraModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-gradient-warning">
        <h5 class="modal-title text-white" id="yaraModalLabel">
          <i class="fas fa-search me-2"></i>
          YARA Scan
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="/admin/yara" enctype="multipart/form-data">
        <div class="modal-body">
          <input type="hidden" name="agent_id" value="{{ agent['id'] }}">
          <div class="mb-3">
            <label for="rules" class="form-label fw-bold">YARA Rules File</label>
            <input class="form-control" type="file" name="rules" accept=".yar,.yara" required>
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i>
              Upload a .yar or .yara file containing your scanning rules
            </div>
          </div>
          <div class="alert alert-info">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Tip:</strong> The scan will run in the agent's current working directory. Use shell commands like <code>cd</code> to navigate to specific directories.
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-warning">
            <i class="fas fa-search me-1"></i> Run YARA Scan
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Directory Browser Modal -->
<div class="modal fade" id="directoryModal" tabindex="-1" aria-labelledby="directoryModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content shadow-lg">
      <div class="modal-header bg-gradient-secondary">
        <h5 class="modal-title text-white" id="directoryModalLabel">
          <i class="fas fa-folder me-2"></i>
          Browse Directory
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <form method="POST" action="/admin/list_dir">
        <div class="modal-body">
          <input type="hidden" name="agent_id" value="{{ agent['id'] }}">
          <input type="hidden" name="agent_url" value="{{ agent['url'] }}">
          <div class="mb-3">
            <label for="dir_path" class="form-label fw-bold">Directory Path</label>
            <input type="text" class="form-control" name="dir_path" placeholder="C:/Users/Agent/Desktop" required>
            <div class="form-text">
              <i class="fas fa-info-circle me-1"></i>
              Enter the full path to the directory you want to explore
            </div>
          </div>
          <div class="alert alert-info">
            <i class="fas fa-lightbulb me-2"></i>
            <strong>Examples:</strong> <code>C:\Users\Agent\Desktop</code>, <code>/home/agent/documents</code>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-secondary">
            <i class="fas fa-folder me-1"></i> Browse Directory
          </button>
        </div>
      </form>
    </div>
  </div>
</div>
{% endblock %}
