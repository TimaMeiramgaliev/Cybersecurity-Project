{% extends "layouts/base.html" %}

{% block title %} {% if page_title %} {{page_title}} {% else %} Cases {% endif %} {% endblock title %}

{% block extrastyle %}
<style>
  .stat-card {
    transition: all 0.3s ease;
  }
  .stat-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(0,0,0,0.12) !important;
  }
  .table-card {
    border-radius: 15px;
    overflow: hidden;
  }
  .table-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    padding: 1.5rem;
  }
  .table-responsive {
    border-radius: 0 0 15px 15px;
  }
  .table th {
    background-color: #f8f9fa;
    border: none;
    font-weight: 600;
    color: #495057;
    padding: 1rem 0.75rem;
    font-size: 0.875rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  .table td {
    padding: 1rem 0.75rem;
    vertical-align: middle;
    border-bottom: 1px solid #f1f3f4;
    font-size: 0.875rem;
  }
  .table tbody tr {
    transition: all 0.2s ease;
  }
  .table tbody tr:hover {
    background-color: #f8f9fa;
    transform: scale(1.01);
  }
  .action-buttons {
    opacity: 0;
    transition: all 0.3s ease;
  }
  .table tbody tr:hover .action-buttons {
    opacity: 1;
  }
  .filter-card {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
    color: white;
  }
  .search-box {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: white;
  }
  .search-box::placeholder {
    color: rgba(255, 255, 255, 0.7);
  }
  .search-box:focus {
    background: rgba(255, 255, 255, 0.15);
    border-color: rgba(255, 255, 255, 0.3);
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(255, 255, 255, 0.25);
  }
  .btn-custom {
    border-radius: 25px;
    padding: 0.5rem 1.5rem;
    font-weight: 500;
    transition: all 0.3s ease;
  }
  .btn-custom:hover {
    transform: translateY(-2px);
    box-shadow: 0 5px 15px rgba(0,0,0,0.2);
  }
  .modal-content {
    border-radius: 15px;
    border: none;
    box-shadow: 0 20px 40px rgba(0,0,0,0.1);
  }
  .modal-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    border-radius: 15px 15px 0 0;
    border: none;
  }
  .modal-title {
    color: white;
    font-weight: 600;
  }
  .close {
    color: white;
    opacity: 0.8;
    transition: opacity 0.3s ease;
  }
  .close:hover {
    opacity: 1;
  }
  .pagination .page-link {
    border-radius: 8px;
    margin: 0 2px;
    border: none;
    color: #6c757d;
    transition: all 0.3s ease;
  }
  .pagination .page-link:hover {
    background-color: #007bff;
    color: white;
    transform: translateY(-2px);
  }
  .pagination .page-item.active .page-link {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
  }
  .dropdown-menu {
    border-radius: 15px;
    border: none;
    box-shadow: 0 10px 30px rgba(0,0,0,0.1);
    max-height: 350px;
    overflow-y: auto;
  }
  .form-check-input:checked {
    background-color: #667eea;
    border-color: #667eea;
  }
  .badge-custom {
    border-radius: 20px;
    padding: 0.5rem 1rem;
    font-size: 0.75rem;
    font-weight: 500;
  }
</style>
{% endblock extrastyle %}

{% block content %}
<div class="container-fluid py-4">
  <!-- Header Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card bg-gradient-primary shadow-primary border-radius-lg">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <div class="col-auto">
              <div class="icon icon-shape icon-xl bg-white shadow text-center rounded-circle">
                <i class="fas fa-table text-primary text-gradient opacity-10"></i>
              </div>
            </div>
            <div class="col">
              <h3 class="text-white mb-0">{{ link|title }} Management</h3>
              <p class="text-white opacity-8 mb-0">Data Table & Records Management</p>
            </div>
            <div class="col-auto">
              <span class="badge bg-white text-primary fs-6">{{ items|length }} Records</span>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card stat-card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-capitalize font-weight-bold">Total Records</p>
                <h5 class="font-weight-bolder mb-0">{{ items|length }}</h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape icon-sm bg-gradient-primary shadow text-center rounded-circle">
                <i class="fas fa-database text-white opacity-10"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card stat-card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-capitalize font-weight-bold">Fields</p>
                <h5 class="font-weight-bolder mb-0">{{ db_field_names|length }}</h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape icon-sm bg-gradient-success shadow text-center rounded-circle">
                <i class="fas fa-columns text-white opacity-10"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card stat-card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-capitalize font-weight-bold">Page Size</p>
                <h5 class="font-weight-bolder mb-0">{{ page_items }}</h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape icon-sm bg-gradient-info shadow text-center rounded-circle">
                <i class="fas fa-list-ol text-white opacity-10"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="col-xl-3 col-md-6 mb-4">
      <div class="card stat-card">
        <div class="card-body p-3">
          <div class="row">
            <div class="col-8">
              <div class="numbers">
                <p class="text-sm mb-0 text-capitalize font-weight-bold">Current Page</p>
                <h5 class="font-weight-bolder mb-0">{{ pagination.page }}</h5>
              </div>
            </div>
            <div class="col-4 text-end">
              <div class="icon icon-shape icon-sm bg-gradient-warning shadow text-center rounded-circle">
                <i class="fas fa-file-alt text-white opacity-10"></i>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Search and Controls Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card filter-card">
        <div class="card-body p-4">
          <div class="row align-items-center">
            <!-- Search -->
            <div class="col-lg-4 col-md-6 mb-3 mb-md-0">
              <form class="search">
                <div class="input-group">
                  <input type="text" placeholder="Search for items..." name="search" class="form-control search-box">
                  <button type="submit" class="btn btn-light btn-custom">
                    <i class="fas fa-search me-1"></i> Search
                  </button>
                </div>
              </form>
            </div>

            <!-- Hide/Show Columns -->
            <div class="col-lg-3 col-md-6 mb-3 mb-md-0">
              <form method="post">
                <div class="dropdown">
                  <button class="btn btn-light btn-custom dropdown-toggle w-100" type="button" data-bs-toggle="dropdown">
                    <i class="fas fa-eye me-1"></i> Hide/Show Columns
                  </button>
                  <div id="dropdownDefaultCheckbox">
                    <ul class="dropdown-menu w-100">
                      {% for field_name in field_names %}
                        <li class="px-3 py-2">
                          <div class="form-check">
                            <input class="form-check-input" {% if field_name.value %} checked {% endif %} type="checkbox" data-bs-target="{{ field_name.key }}" value="" id="checkbox-item-{{ field_name.id }}">
                            <label class="form-check-label" for="checkbox-item-{{ field_name.id }}">
                              {{ field_name.key }}
                            </label>
                          </div>
                        </li>
                      {% endfor %}
                    </ul>
                  </div>
                </div>
              </form>
            </div>

            <!-- Page Size -->
            <div class="col-lg-3 col-md-6 mb-3 mb-md-0">
              <form method="post" class="page-size">
                <select onchange="getPageItems(this)" class="form-select border-0 rounded-pill">
                  <option {% if page_items == 5 %} selected {% endif %} value="5">5 Items</option>
                  <option {% if page_items == 10 %} selected {% endif %} value="10">10 Items</option>
                  <option {% if page_items == 15 %} selected {% endif %} value="15">15 Items</option>
                  <option {% if page_items == 25 %} selected {% endif %} value="25">25 Items</option>
                  <option {% if page_items == 50 %} selected {% endif %} value="50">50 Items</option>
                  <option {% if page_items == 100 %} selected {% endif %} value="100">100 Items</option>
                </select>
              </form>
            </div>

            <!-- Actions -->
            <div class="col-lg-2 col-md-6">
              <div class="d-flex gap-2">
                <button data-bs-toggle="modal" data-bs-target="#exportCSV" class="btn btn-light btn-custom">
                  <i class="fas fa-download me-1"></i> Export
                </button>
                {% if current_user.is_authenticated %}
                <button data-bs-toggle="modal" data-bs-target="#addSales" class="btn btn-success btn-custom">
                  <i class="fas fa-plus me-1"></i> Add
                </button>
                {% endif %}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Filters Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header p-3 pb-0">
          <h6 class="mb-0">
            <i class="fas fa-filter text-primary me-2"></i>
            Advanced Filters
          </h6>
        </div>
        <div class="card-body p-3">
          <form action="{{ url_for('table_blueprint.create_filter', model_name=link) }}" method="post">
            <div class="d-flex align-items-center gap-3 mb-3">
              <button id="addButton" type="button" class="btn btn-primary btn-custom">
                <i class="fas fa-plus me-1"></i> Add Filter
              </button>
            </div>

            <div class="mb-3" id="inputContainer">
              {% if filter_instance %}
                {% for filter_data in filter_instance %}
                <div class="input-container d-flex align-items-center gap-3 mb-3">
                  <div class="d-flex gap-2 flex-grow-1">
                    <select name="key" class="form-select border rounded-pill">
                      {% for field in db_field_names %}
                        <option {% if filter_data.key == field %}selected{% endif %} value="{{ field }}">{{ field }}</option>
                      {% endfor %}
                    </select>
                    <input name="value" value="{{ filter_data.value }}" class="form-control border rounded-pill" type="text" placeholder="Enter value">
                  </div>
                  <a href="{{ url_for('table_blueprint.delete_filter', model_name=link, id=filter_data.id) }}" class="btn btn-danger btn-custom">
                    <i class="fas fa-times"></i>
                  </a>
                </div>
                {% endfor %}
              {% endif %}
            </div>
            <button id="submitButton" type="submit" {% if not filter_instance %} style="display: none;" {% endif %} class="btn btn-success btn-custom">
              <i class="fas fa-check me-1"></i> Apply Filters
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Data Table Section -->
  <div class="row">
    <div class="col-12">
      <div class="card table-card">
        <div class="table-header">
          <div class="row align-items-center">
            <div class="col">
              <h5 class="mb-0">
                <i class="fas fa-table me-2"></i>
                {{ link|title }} Data Table
              </h5>
              <p class="mb-0 opacity-8">Showing {{ items|length }} records</p>
            </div>
            <div class="col-auto">
              <span class="badge bg-light text-dark badge-custom">
                <i class="fas fa-database me-1"></i>{{ db_field_names|length }} Fields
              </span>
            </div>
          </div>
        </div>

        <div class="table-responsive">
          <table class="table table-hover mb-0">
            <thead>
              <tr>
                {% for field in db_field_names %}
                  <th id="th_{{ field }}" class="px-3" scope="col">{{ field|title }}</th>
                {% endfor %}
                {% if current_user.is_authenticated or not current_user.is_authenticated %}
                  <th class="px-3" scope="col">Actions</th>
                {% endif %}
              </tr>
            </thead>
            <tbody>
              {% for item in items %}
              <tr class="align-middle">
                {% for field_name in db_field_names %}
                  {% if field_name in choices_dict %}
                  <td class="td_{{ field_name }} px-3">
                    <span class="badge bg-info badge-custom">{{ item|getenumattribute(field_name) }}</span>
                  </td>
                  {% else %}
                  <td class="td_{{ field_name }} px-3">{{ item|getattribute(field_name) }}</td>
                  {% endif %}
                {% endfor %}

                {% if current_user.is_authenticated %}
                <td class="px-3">
                  <div class="action-buttons d-flex gap-2">
                    <button data-bs-toggle="modal" data-bs-target="#editSales-{{item.id}}" class="btn btn-primary btn-sm btn-custom">
                      <i class="fas fa-edit"></i>
                    </button>
                    <button data-bs-toggle="modal" data-bs-target="#deleteSales-{{item.id}}" class="btn btn-danger btn-sm btn-custom">
                      <i class="fas fa-trash"></i>
                    </button>
                  </div>
                </td>
                {% else %}
                <td class="px-3">
                  <div class="action-buttons d-flex gap-2">
                    <button data-bs-toggle="modal" data-bs-target="#viewSales-{{item.id}}" class="btn btn-info btn-sm btn-custom">
                      <i class="fas fa-eye"></i>
                    </button>
                  </div>
                </td>
                {% endif %}
              </tr>

              <!-- Edit Modal -->
              <div class="modal fade" id="editSales-{{item.id}}" tabindex="-1" aria-labelledby="editSalesLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="editSalesLabel">
                        <i class="fas fa-edit me-2"></i>Edit {{ link|title }}
                      </h5>
                      <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <form action="{{ url_for('table_blueprint.update', aPath=link, id=item.id ) }}" method="post">
                        <div class="row">
                          <!-- FKs -->
                          {% for key, values in fk_fields.items() %}
                          <div class="col-md-6 mb-3">
                            <label for="id_{{ key }}" class="form-label">{{ key|title }}</label>
                            <select class="form-select border rounded-pill" name="{{ key }}" id="id_{{ key }}">
                              {% for i in values %}
                                <option value="{{ i.id }}">{{ i }}</option>
                              {% endfor %}
                            </select>
                          </div>
                          {% endfor %}

                          {% for field_name in db_field_names %}
                            {% if field_name not in read_only_fields and field_name not in fk_fields_keys and field_name not in exclude_auto_gen_fields %}
                            <div class="col-md-6 mb-3">
                              <label for="id_{{ field_name }}" class="form-label">{{ field_name|title }}</label>
                              {% if field_name in choices_dict %}
                                <select name="{{ field_name }}" id="id_{{ field_name }}" class="form-select border rounded-pill">
                                  <option value="">Select {{ field_name }}</option>
                                  {% for key, value in choices_dict|get(field_name) %}
                                    <option {% if item|getenumattribute(field_name) == value %}selected{% endif %} value="{{ value }}">{{ key }}</option>
                                  {% endfor %}
                                </select>
                              {% else %}
                                {% if field_name in integer_fields %}
                                <input type="number" name="{{ field_name }}" value="{{ item|getattribute(field_name) }}" class="form-control border rounded-pill" placeholder="{{ field_name }}" id="id_{{ field_name }}">
                                {% elif field_name in date_time_fields %}
                                <input type="datetime-local" name="{{ field_name }}" value="{{ item|getattribute(field_name) }}" class="form-control border rounded-pill" placeholder="{{ field_name }}" id="id_{{ field_name }}">
                                {% elif field_name in email_fields %}
                                <input type="email" name="{{ field_name }}" value="{{ item|getattribute(field_name) }}" class="form-control border rounded-pill" placeholder="{{ field_name }}" id="id_{{ field_name }}">
                                {% elif field_name in text_fields %}
                                <input type="text" name="{{ field_name }}" value="{{ item|getattribute(field_name) }}" class="form-control border rounded-pill" placeholder="{{ field_name }}" id="id_{{ field_name }}">
                                {% else %}
                                <input type="text" name="{{ field_name }}" value="{{ item|getattribute(field_name) }}" class="form-control border rounded-pill" placeholder="{{ field_name }}" id="id_{{ field_name }}">
                                {% endif %}
                              {% endif %}
                            </div>
                            {% endif %}
                          {% endfor %}
                        </div>
                        <div class="text-end">
                          <button type="submit" class="btn btn-primary btn-custom">
                            <i class="fas fa-save me-1"></i> Save Changes
                          </button>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Delete Modal -->
              <div class="modal fade" id="deleteSales-{{item.id}}" tabindex="-1" aria-labelledby="deleteSalesLabel" aria-hidden="true">
                <div class="modal-dialog">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="deleteSalesLabel">
                        <i class="fas fa-exclamation-triangle text-warning me-2"></i>Delete Item
                      </h5>
                      <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body text-center">
                      <i class="fas fa-question-circle text-warning" style="font-size: 3rem;"></i>
                      <h5 class="mt-3">Are you sure you want to delete this item?</h5>
                      <p class="text-muted">This action cannot be undone.</p>
                    </div>
                    <div class="modal-footer">
                      <button type="button" class="btn btn-secondary btn-custom" data-bs-dismiss="modal">Cancel</button>
                      <a href="{{ url_for('table_blueprint.delete', aPath=link, id=item.id ) }}" class="btn btn-danger btn-custom">
                        <i class="fas fa-trash me-1"></i> Delete
                      </a>
                    </div>
                  </div>
                </div>
              </div>

              <!-- View Modal -->
              <div class="modal fade" id="viewSales-{{item.id}}" tabindex="-1" aria-labelledby="viewSalesLabel" aria-hidden="true">
                <div class="modal-dialog modal-dialog-centered modal-lg">
                  <div class="modal-content">
                    <div class="modal-header">
                      <h5 class="modal-title" id="viewSalesLabel">
                        <i class="fas fa-eye me-2"></i>View {{ link|title }}
                      </h5>
                      <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                      </button>
                    </div>
                    <div class="modal-body">
                      <div class="row">
                        {% for field_name in db_field_names %}
                        <div class="col-md-6 mb-3">
                          <label class="form-label fw-bold">{{ field_name|title }}</label>
                          <div class="form-control-plaintext border rounded p-2 bg-light">
                            {{ item|getattribute(field_name) }}
                          </div>
                        </div>
                        {% endfor %}
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  {% if pagination.has_prev or pagination.has_next %}
  <div class="row mt-4">
    <div class="col-12">
      <div class="card">
        <div class="card-body p-3">
          <nav aria-label="Page navigation">
            <ul class="pagination justify-content-center mb-0">
              {% if pagination.has_prev %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ pagination.prev_num }}" aria-label="Previous">
                    <i class="fas fa-chevron-left"></i>
                  </a>
                </li>
              {% endif %}
              {% for n in range(1, pagination.pages + 1) %}
                {% if pagination.page == n %}
                  <li class="page-item active"><a class="page-link">{{ n }}</a></li>
                {% elif n > pagination.page - 3 and n < pagination.page + 3 %}
                  <li class="page-item"><a class="page-link" href="?page={{ n }}">{{ n }}</a></li>
                {% endif %}
              {% endfor %}
              {% if pagination.has_next %}
                <li class="page-item">
                  <a class="page-link" href="?page={{ pagination.next_num }}" aria-label="Next">
                    <i class="fas fa-chevron-right"></i>
                  </a>
                </li>
              {% endif %}
            </ul>
          </nav>
        </div>
      </div>
    </div>
  </div>
  {% endif %}
</div>

<!-- Export CSV Modal -->
<div class="modal fade" id="exportCSV" tabindex="-1" aria-labelledby="exportCSVLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exportCSVLabel">
          <i class="fas fa-download me-2"></i>Export as CSV
        </h5>
        <div class="d-flex align-items-center gap-2">
          <a href="{{ url_for('table_blueprint.export_csv', aPath=link) }}" class="btn btn-success btn-custom">
            <i class="fas fa-download me-1"></i> Download CSV
          </a>
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
      </div>
      <div class="modal-body">
        {% include "includes/items-table.html" %}
      </div>
    </div>
  </div>
</div>

<!-- Add Item Modal -->
<div class="modal fade" id="addSales" tabindex="-1" aria-labelledby="addSalesLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="addSalesLabel">
          <i class="fas fa-plus me-2"></i>Add {{ link|title }}
        </h5>
        <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body">
        <form method="post" action="{{ url_for('table_blueprint.create', aPath=link) }}">
          <div class="row">
            <!-- FKs -->
            {% for field, values in fk_fields.items() %}
            <div class="col-md-6 mb-3">
              <label for="id_{{ field }}" class="form-label">{{ field|title }}</label>
              <select class="form-select border rounded-pill" name="{{ field }}" id="id_{{ field }}">
                {% for i in values %}
                  <option value="{{ i.id }}">{{ i }}</option>
                {% endfor %}
              </select>
            </div>
            {% endfor %}

            {% for field_name in db_field_names %}
              {% if field_name not in read_only_fields and field_name not in fk_fields_keys and field_name not in exclude_auto_gen_fields %}
              <div class="col-md-6 mb-3">
                <label for="id_{{ field_name }}" class="form-label">{{ field_name|title }}</label>
                {% if field_name in choices_dict %}
                  <select name="{{ field_name }}" id="id_{{ field_name }}" class="form-select border rounded-pill">
                    <option value="">Select {{ field_name }}</option>
                    {% for key, value in choices_dict|get(field_name) %}
                      <option value="{{ key }}">{{ key }}</option>
                    {% endfor %}
                  </select>
                {% else %}
                  {% if field_name in integer_fields %}
                  <input type="number" name="{{ field_name }}" class="form-control border rounded-pill" placeholder="{{ field_name|title }}" id="id_{{ field_name }}">
                  {% elif field_name in date_time_fields %}
                  <input type="datetime-local" name="{{ field_name }}" class="form-control border rounded-pill" placeholder="{{ field_name|title }}" id="id_{{ field_name }}">
                  {% elif field_name in email_fields %}
                  <input type="email" name="{{ field_name }}" class="form-control border rounded-pill" placeholder="{{ field_name|title }}" id="id_{{ field_name }}">
                  {% else %}
                  <input type="text" name="{{ field_name }}" class="form-control border rounded-pill" placeholder="{{ field_name|title }}" id="id_{{ field_name }}">
                  {% endif %}
                {% endif %}
              </div>
              {% endif %}
            {% endfor %}
          </div>

          <div class="text-end">
            <button type="submit" class="btn btn-success btn-custom">
              <i class="fas fa-plus me-1"></i> Add {{ link|title }}
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

{% endblock %}

{% block extra_js %}
<script>
  const link = '{{ link }}';
  const hideShowLink = "{{ url_for('table_blueprint.create_hide_show_filter', model_name=link) }}"
  const pageItemsLink = "{{ url_for('table_blueprint.create_page_items', model_name=link) }}"

  // Function to notify dashboard about updates
  function notifyDashboardUpdate(action, itemId = null) {
    try {
      // Try to send message to parent window (if this is in an iframe)
      if (window.parent && window.parent !== window) {
        window.parent.postMessage({
          type: 'CASE_UPDATED',
          action: action,
          itemId: itemId,
          timestamp: new Date().toISOString()
        }, '*');
      }

      // Update localStorage to notify other tabs
      localStorage.setItem('case_management_updated', JSON.stringify({
        action: action,
        itemId: itemId,
        timestamp: new Date().toISOString()
      }));

      // Dispatch a custom event for the current page
      window.dispatchEvent(new CustomEvent('caseUpdated', {
        detail: { action, itemId }
      }));

      console.log('Dashboard update notification sent:', { action, itemId });
    } catch (error) {
      console.error('Error notifying dashboard:', error);
    }
  }

  document.addEventListener('DOMContentLoaded', function () {
    var checkboxes = document.querySelectorAll('#dropdownDefaultCheckbox input[type="checkbox"]');

    checkboxes.forEach(function (checkbox) {
      var targetColumnId = checkbox.getAttribute('data-bs-target');
      var targetColumn = document.getElementById('th_' + targetColumnId);
      var exportTargetColumn = document.getElementById('th_' + targetColumnId + '_export');
      var targetDataCells = document.querySelectorAll('.td_' + targetColumnId);

      if (checkbox.checked) {
        targetColumn.style.display = 'none';
        if (exportTargetColumn) exportTargetColumn.style.display = 'none';
        targetDataCells.forEach(function (dataCell) {
          dataCell.style.display = 'none';
        });
      }

      checkbox.addEventListener('change', function () {
        var targetColumnId = this.getAttribute('data-bs-target');
        var targetColumn = document.getElementById('th_' + targetColumnId);
        var exportTargetColumn = document.getElementById('th_' + targetColumnId + '_export');
        var targetDataCells = document.querySelectorAll('.td_' + targetColumnId);

        if (this.checked) {
          targetColumn.style.display = 'none';
          if (exportTargetColumn) exportTargetColumn.style.display = 'none';
          targetDataCells.forEach(function (dataCell) {
            dataCell.style.display = 'none';
          });
        } else {
          targetColumn.style.display = '';
          if (exportTargetColumn) exportTargetColumn.style.display = '';
          targetDataCells.forEach(function (dataCell) {
            dataCell.style.display = '';
          });
        }

        fetch(hideShowLink, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
          },
          body: JSON.stringify({
            key: targetColumnId,
            value: this.checked
          })
        })
      });
    });

    // Add form submission listeners for CRUD operations
    setupFormListeners();
  });

  // Function to setup form listeners for CRUD operations
  function setupFormListeners() {
    // Listen for form submissions
    document.addEventListener('submit', function(event) {
      const form = event.target;
      const action = form.getAttribute('action') || '';

      // Check if this is a CRUD operation
      if (action.includes('/create/') || action.includes('/update/') || action.includes('/delete/')) {
        // Add a small delay to allow the form to submit first
        setTimeout(() => {
          if (action.includes('/create/')) {
            notifyDashboardUpdate('created');
          } else if (action.includes('/update/')) {
            notifyDashboardUpdate('updated');
          } else if (action.includes('/delete/')) {
            notifyDashboardUpdate('deleted');
          }
        }, 100);
      }
    });

    // Listen for delete button clicks (since they use GET requests)
    document.addEventListener('click', function(event) {
      if (event.target && event.target.closest('a[href*="/delete/"]')) {
        const link = event.target.closest('a[href*="/delete/"]');
        const href = link.getAttribute('href');
        if (href && href.includes('/delete/')) {
          // Extract item ID from the href
          const itemId = href.split('/').pop();
          setTimeout(() => {
            notifyDashboardUpdate('deleted', itemId);
          }, 100);
        }
      }
    });
  }

  function getPageItems(selectObject) {
    var value = selectObject.value;

    fetch(pageItemsLink, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/x-www-form-urlencoded',
      },
      body: `items=${value}`
    })
    .then(response => {
      location.reload()
    })
  }

  document.getElementById('addButton').addEventListener('click', function() {
    var fieldNames = {{ db_filters|safe }};

    var template = `
      <div class="input-container d-flex align-items-center gap-3 mb-3">
        <div class="d-flex gap-2 flex-grow-1">
          <select name="key" class="form-select border rounded-pill">
            ${fieldNames.map(function(option) { return '<option value="' + option + '">' + option + '</option>'; }).join('')}
          </select>
          <input name="value" class="form-control border rounded-pill" type="text" placeholder="Enter value">
        </div>
        <button class="remove-button btn btn-danger btn-custom" onclick="removeInputContainer(this)">
          <i class="fas fa-times"></i>
        </button>
      </div>
    `;

    var tempDiv = document.createElement('div');
    tempDiv.innerHTML = template;

    document.getElementById('inputContainer').appendChild(tempDiv);
    document.getElementById('submitButton').style.display = 'inline-block';
  });

  function removeInputContainer(element) {
    var inputContainer = element.closest('.input-container');
    inputContainer.remove();

    var inputContainers = document.getElementsByClassName('input-container');
    if (inputContainers.length === 0) {
      document.getElementById('submitButton').style.display = 'none';
    }
  }

  // Listen for successful form submissions and show success messages
  document.addEventListener('DOMContentLoaded', function() {
    // Check if there's a success message in the URL
    const urlParams = new URLSearchParams(window.location.search);
    if (urlParams.get('success')) {
      // Show success message
      showNotification('Operation completed successfully!', 'success');

      // Notify dashboard about the update
      notifyDashboardUpdate('completed');
    }
  });

  // Function to show notifications
  function showNotification(message, type = 'info') {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `alert alert-${type} alert-dismissible fade show position-fixed`;
    notification.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
    notification.innerHTML = `
      ${message}
      <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    `;

    // Add to page
    document.body.appendChild(notification);

    // Auto-remove after 5 seconds
    setTimeout(() => {
      if (notification.parentNode) {
        notification.remove();
      }
    }, 5000);
  }
</script>
{% endblock extra_js %}